{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "defaultValue": "[resourceGroup().location]",
            "type": "string"
        },
        "mysqlAdministratorLogin": {
            "defaultValue": "magento",
            "type": "string"
        },
        "mysqlAdministratorPassword": {
            "type": "securestring"
        },
        "aksServicePrincipalClientId": {
            "type": "string"
        },
        "aksServicePrincipalSecret": {
            "type": "securestring"
        },
        "aksNodePoolSize": {
            "defaultValue": 10,
            "type": "int"
        }
    },
    "variables": {
        "kubernetesSubnetName": "kubernetes",
        "nameSuffix": "[uniqueString(resourceGroup().id)]",
        "aksClusterName": "[concat('magento-aks-', variables('nameSuffix'))]",
        "aksDnsPrefix": "[concat('magento-aks-dns', variables('nameSuffix'))]",
        "aksWorkerResourceGroupName": "[concat('magento-aks-worker-rg-', variables('nameSuffix'))]",
        "cdnProfileName": "[concat('magento-cdn-', variables('nameSuffix'))]",
        "containerRegistryName": "[concat('magentocr', variables('nameSuffix'))]",
        "mysqlServerName": "[concat('magento-mysql-', variables('nameSuffix'))]",
        "redisCacheName": "[concat('magento-redis-', variables('nameSuffix'))]",
        "storageAccountName": "[concat('magentofile', variables('nameSuffix'))]",
        "virtualNetworkName": "[concat('magento-vnet-', variables('nameSuffix'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworkName')]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.0.0.0/8"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('kubernetesSubnetName')]",
                        "properties": {
                            "addressPrefix": "10.1.0.0/16",
                            "serviceEndpoints": [
                                {
                                    "service": "Microsoft.Sql",
                                    "locations": [
                                        "[parameters('location')]"
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "name": "redis",
                        "properties": {
                            "addressPrefix": "10.2.0.0/24"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Cache/Redis",
            "apiVersion": "2018-03-01",
            "name": "[variables('redisCacheName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
            ],
            "properties": {
                "sku": {
                    "name": "Premium",
                    "family": "P",
                    "capacity": 3
                },
                "enableNonSslPort": true,
                "minimumTlsVersion": "1.2",
                "redisConfiguration": {
                    "maxclients": "20000",
                    "maxmemory-reserved": "5000",
                    "maxfragmentationmemory-reserved": "2650",
                    "maxmemory-policy": "volatile-lru",
                    "maxmemory-delta": "5000"
                },
                "subnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), 'redis')]"
            }
        },
        {
            "type": "Microsoft.ContainerRegistry/registries",
            "apiVersion": "2019-05-01",
            "name": "[variables('containerRegistryName')]",
            "location": "[resourceGroup().location]",
            "sku": {
                "name": "Standard",
                "tier": "Standard"
            },
            "properties": {
                "adminUserEnabled": true,
                "policies": {
                    "quarantinePolicy": {
                        "status": "disabled"
                    },
                    "trustPolicy": {
                        "type": "Notary",
                        "status": "disabled"
                    },
                    "retentionPolicy": {
                        "days": 7,
                        "status": "disabled"
                    }
                }
            }
        },
        {
            "type": "Microsoft.DBforMySQL/servers",
            "apiVersion": "2017-12-01",
            "name": "[variables('mysqlServerName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "MO_Gen5_16",
                "tier": "MemoryOptimized",
                "family": "Gen5",
                "capacity": 16
            },
            "properties": {
                "administratorLogin": "[parameters('mysqlAdministratorLogin')]",
                "administratorLoginPassword": "[parameters('mysqlAdministratorPassword')]",
                "storageProfile": {
                    "storageMB": 512000,
                    "backupRetentionDays": 7,
                    "geoRedundantBackup": "Disabled",
                    "storageAutoGrow": "Enabled"
                },
                "version": "8.0",
                "sslEnforcement": "Enabled",
                "minimalTlsVersion": "TLSEnforcementDisabled",
                "infrastructureEncryption": "Disabled",
                "publicNetworkAccess": "Enabled"
            },
            "resources": [
                {
                    "type": "configurations",
                    "name": "log_bin_trust_function_creators",
                    "apiVersion": "2017-12-01",
                    "location": "[parameters('location')]",
                    "properties": {
                        "value": "ON",
                        "source": "user-override"
                    },
                    "dependsOn": [
                        "[variables('mysqlServerName')]"
                    ]
                },
                {
                    "type": "firewallRules",
                    "apiVersion": "2017-12-01",
                    "name": "AllowAll",
                    "dependsOn": [
                        "[variables('mysqlServerName')]"
                    ],
                    "properties": {
                        "startIpAddress": "0.0.0.0",
                        "endIpAddress": "255.255.255.255"
                    }
                },
                {
                    "type": "databases",
                    "apiVersion": "2017-12-01",
                    "name": "magento2",
                    "dependsOn": [
                        "[variables('mysqlServerName')]"
                    ],
                    "properties": {
                        "charset": "latin1",
                        "collation": "latin1_swedish_ci"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.ContainerService/managedClusters",
            "apiVersion": "2019-10-01",
            "name": "[variables('aksClusterName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/servers/virtualNetworkRules', variables('mysqlServerName'), 'kubernetes-vnet')]"
            ],
            "properties": {
                "kubernetesVersion": "1.16.7",
                "dnsPrefix": "[variables('aksDnsPrefix')]",
                "agentPoolProfiles": [
                    {
                        "name": "agentpool",
                        "count": 5,
                        "vmSize": "Standard_F8s_v2",
                        "osDiskSizeGB": 0,
                        "vnetSubnetID": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('kubernetesSubnetName'))]",
                        "type": "VirtualMachineScaleSets",
                        "osType": "Linux",
                        "storageProfile": "ManagedDisks"
                    }
                ],
                "servicePrincipalProfile": {
                    "clientId": "[parameters('aksServicePrincipalClientId')]",
                    "secret": "[parameters('aksServicePrincipalSecret')]"
                },
                "enableRBAC": true,
                "networkProfile": {
                    "networkPlugin": "azure",
                    "loadBalancerSku": "Standard",
                    "serviceCidr": "10.0.0.0/16",
                    "dnsServiceIP": "10.0.0.10",
                    "dockerBridgeCidr": "172.17.0.1/16"
                }
            }
        },
        {
            "type": "Microsoft.DBforMySQL/servers/virtualNetworkRules",
            "apiVersion": "2017-12-01",
            "name": "[concat(variables('mysqlServerName'), '/kubernetes-vnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.DBforMySQL/servers', variables('mysqlServerName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]"
            ],
            "properties": {
                "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'), variables('kubernetesSubnetName'))]",
                "ignoreMissingVnetServiceEndpoint": false
            }
        },
        {
            "name": "[variables('cdnProfileName')]",
            "type": "Microsoft.Cdn/profiles",
            "location": "[parameters('location')]",
            "apiVersion": "2016-04-02",
            "sku": {
                "name": "Standard_Akamai"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2018-07-01",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('location')]",
            "kind": "StorageV2",
            "sku": {
                "name": "Standard_LRS",
                "tier": "Standard"
            },
            "properties": {
                "accessTier": "Hot"
            }
        },
        {
            "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
            "apiVersion": "2019-04-01",
            "name": "[concat(variables('storageAccountName'), '/default/pub')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            ]
        }
    ]
}
